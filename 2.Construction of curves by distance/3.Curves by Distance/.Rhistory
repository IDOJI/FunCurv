ylab = "Value",
color_legend_title = "Category",
# export
path_Export = NULL,
file.name = NULL,
width = 20,
height = 5){
# ğŸŸ¥ Colnames ====================================================================
## ğŸŸ¨ Check input ===============================================================
if(is.null(col_names)){
col_names = colnames(df)
col_names = col_names[col_names != x_col]
}
## ğŸŸ¨ Subset ===============================================================
df_selected = df[, c(x_col, col_names), drop = FALSE]
# ğŸŸ¥ x-axis ====================================================================
if(is.null(x_axis_vals)){
x_axis_vals = 1:nrow(df_selected)
}
if(nrow(df_selected)!=length(x_axis_vals)){
stop("Compare the length of x_axis_vals and the rows of df")
}
x_axis_labs = df_selected[, x_col]
# ğŸŸ¥ Transform data into long format ============================================================
df_selected$Year = df_selected$Year %>% as.numeric
long_df = df_selected %>% pivot_longer(cols = -!!x_col,
names_to = "Category",
values_to = "Value") %>% dplyr::arrange(Category, !!x_col)
# ğŸŸ¥ Add x-axis vals ============================================================
x.axis_df = cbind(x_axis_vals = x_axis_vals, long_df)
x.axis_df$Value = as.numeric(x.axis_df$Value)
x.axis_df$x_axis_vals = as.numeric(x.axis_df$x_axis_vals)
# ğŸŸ¥ plotting ====================================================================
## ğŸŸ¨ Line ============================================================================
p <- ggplot() +
geom_line(data = x.axis_df, aes(x = x_axis_vals, y = Value, group = Category, color = Category),
show.legend = show.legend)
## ğŸŸ¨ Point ============================================================================
if(point){
p = p + geom_point(data = x.axis_df,
aes(x = x_axis_vals, y = Value, group = Category, color = Category),
show.legend = FALSE) # ì„  ìœ„ì— ì  ì¶”ê°€, ë²”ë¡€ëŠ” ì´ë¯¸ geom_lineì—ì„œ í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
}
## ğŸŸ¨ Lables ============================================================================
p = p + scale_x_discrete(limits = x_axis_labs) + # xì¶• ë¼ë²¨ ì§€ì •
theme_minimal() +
labs(title = title, x = xlab, y = ylab, color = color_legend_title)
## ğŸŸ¨ Theme ============================================================================
p = p + theme(plot.title = element_text(hjust = 0.5, size = 25, face = "bold"), # íƒ€ì´í‹€ ê°€ìš´ë° ì •ë ¬
axis.title.x = element_text(size = 20, face = "bold"), # x ì¶• ë¼ë²¨ í¬ê¸° ë° êµµê¸° ì¡°ì •
axis.title.y = element_text(size = 20, face = "bold"), # y ì¶• ë¼ë²¨ í¬ê¸° ë° êµµê¸° ì¡°ì •
legend.title = element_text(size = 17, face = "bold") # ë²”ë¡€ ì œëª© í¬ê¸° ë° êµµê¸° ì¡°ì •
)
# ğŸŸ¥ Exporting =================================================================================
if(!is.null(path_Export)){
ggsave(paste0(path_Export, "/", file.name, ".png"), p, bg = "white", width = width, height = height)
}
return(p)
}
## ğŸŸ© FC ==================================================================================================
combine_fisher_z_fc <- function(data_list) {
# Distì™€ ROIê°€ ë™ì¼í•œì§€ í™•ì¸
dist_roi_check <- lapply(data_list, function(df) df[, c("Dist", "ROI")])
# x = dist_roi_check[[2]]
if (!all(sapply(dist_roi_check, function(x) identical(x, dist_roi_check[[1]])))) {
stop("Error: Not all 'Dist' and 'ROI' columns are identical across data frames.")
}
# ë™ì¼í•œ Distì™€ ROIë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²°í•©
dist_and_roi <- dist_roi_check[[1]]  # Distì™€ ROIë¥¼ í¬í•¨í•œ ì²« ë²ˆì§¸ ë°ì´í„°í”„ë ˆì„
# ê° ë°ì´í„°í”„ë ˆì„ì˜ Fisher_Z_FC ì—´ ì´ë¦„ì„ ë¦¬ìŠ¤íŠ¸ ì›ì†Œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ cbind
combined_data <- lapply(names(data_list), function(name) {
# name = names(data_list)[1]
df <- data_list[[name]]
df[["Fisher_Z_FC"]] %>% as_tibble %>% setNames(name)  # ì—´ ì´ë¦„ì„ ë¦¬ìŠ¤íŠ¸ ì›ì†Œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
}) %>% do.call(cbind, .) %>% cbind(dist_and_roi, .) %>% as_tibble
return(combined_data)
}
# FC ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ì €ì¥í•˜ëŠ” í•¨ìˆ˜ ì •ì˜
process_and_save_fc_data <- function(path_folder, path_save, sorted_dist) {
require(tools)
fc_data_list <- list.files(path_folder, full.names = TRUE)
for (ith_fc_path in fc_data_list) {
ith_atlas <- basename(ith_fc_path) %>%
file_path_sans_ext() %>%
sub("_combined_Fisher_Z_fc$", "", .)
save_file_path <- file.path(path_save, paste0(ith_atlas, ".rds"))
if (file.exists(save_file_path)) {
cat(crayon::red(paste("File already exists for atlas:", ith_atlas, ". Skipping processing.\n")))
next
}
total_start_time <- Sys.time()
tryCatch({
ith_fc <- readRDS(ith_fc_path)
}, error = function(e) {
cat(crayon::red(paste("Error reading file:", ith_fc_path, "\n")))
next
})
ith_sorted_dist <- sorted_dist[[ith_atlas]]
ith_sorted_FC_data <- list()
# Sorting
tictoc::tic("Sorting")
each_rid_sorted_FC_list = lapply(names(ith_fc), function(rid){
rid_fc = ith_fc[[rid]]
rid_sorted_FC_list = lapply(names(ith_sorted_dist), function(roi){
roi_rid_fc = rid_fc[,roi]
roi_dist = ith_sorted_dist[[roi]]
selected_roi_rid_fc = roi_rid_fc[names(roi_rid_fc) %in% names(roi_dist)]
sorted_selected_roi_rid_fc = selected_roi_rid_fc[names(roi_dist)]
data.frame(Dist = roi_dist, ROI = names(sorted_selected_roi_rid_fc), Fisher_Z_FC = sorted_selected_roi_rid_fc) %>% as_tibble
}) %>% setNames(names(ith_sorted_dist))
}) %>% setNames(names(ith_fc))
tictoc::toc()
# Combine
# roi = names(ith_sorted_dist)[1]
# ROI ë³„ë¡œ ë°ì´í„° ì²˜ë¦¬ ë° ì‹œê°„ ì¸¡ì • í•¨ìˆ˜
final_combined_data_list <- lapply(names(ith_sorted_dist), function(roi) {
# ì‹œì‘ ì‹œê°„ ê¸°ë¡
start_time <- Sys.time()
# ê° ridì— ëŒ€í•´ Fisher_Z_FC ê²°í•©
combined_roi_fc <- lapply(names(each_rid_sorted_FC_list), function(rid) {
each_rid_sorted_FC_list[[rid]][[roi]]
}) %>%
setNames(names(each_rid_sorted_FC_list)) %>%
combine_fisher_z_fc
# ì¢…ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
end_time <- Sys.time()
elapsed_time <- end_time - start_time
# ë©”ì‹œì§€ ì¶œë ¥: atlas ì´ë¦„ê³¼ roi ì´ë¦„, ì†Œìš” ì‹œê°„ í¬í•¨
cat(crayon::blue(paste0("Finished processing atlas: ", ith_atlas,
" | ROI: ", roi, "\n")))
cat(crayon::green(paste0("Time taken for ROI ", roi, ": ",
round(elapsed_time, 2), " seconds\n")))
return(combined_roi_fc)
}) %>% setNames(names(ith_sorted_dist))
saveRDS(final_combined_data_list, save_file_path)
total_end_time <- Sys.time()
total_elapsed_time <- total_end_time - total_start_time
cat(crayon::yellow(paste0("Finished processing atlas: ", ith_atlas, " | Total time taken: ", round(total_elapsed_time, 2), " seconds\n")))
}
}
## ğŸŸ© ReHo, DC, ALFF ==================================================================================================
process_roi_data <- function(path_data_folder, sorted_dist, path_save) {
# ì €ì¥í•  ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
if (!dir.exists(path_save)) {
dir.create(path_save, recursive = TRUE)
}
# `Mean__`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  rds íŒŒì¼ì˜ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
path_target_data <- list.files(path_data_folder, pattern = "^Mean__.*\\.rds$", full.names = TRUE)
# atlas ì´ë¦„ ì¶”ì¶œ
target_file_names <- list.files(path_data_folder, pattern = "\\.rds$", full.names = FALSE) %>%
sub("\\.rds$", "", .)
target_file_names = target_file_names[!grepl("^Mean__", target_file_names)]
# ì •ë ¬ëœ dist ëª©ë¡ì˜ ì´ë¦„ì´ íŒŒì¼ ì´ë¦„ì— ëª¨ë‘ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
if (all(names(sorted_dist) %in% target_file_names)) {
for (target_atlas_name in target_file_names) {
# target_atlas_name = target_file_names[2]
# ì´ë¯¸ ì €ì¥ëœ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
save_file_path <- file.path(path_save, paste0(target_atlas_name, ".rds"))
if (file.exists(save_file_path)) {
cat(yellow(paste0("Skipping: ", target_atlas_name, " (File already exists)\n")))
next
}
# ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
start_time <- Sys.time()
# í•´ë‹¹ atlasì— ëŒ€í•œ dist ë°ì´í„°ì™€ target data ë¡œë“œ
target_atlas <- sorted_dist[[target_atlas_name]]
target_data <- readRDS(path_target_data[which(target_file_names == target_atlas_name)])
# target_data %>% View
# RID ì¶”ì¶œ ë° target_dataì˜ RID ì—´ ì œê±°
RID <- regmatches(target_data$RID, regexpr("RID_\\d+", target_data$RID))
target_data$RID <- NULL
# ê° ROIì— ëŒ€í•´ ë°ì´í„° ì¬êµ¬ì„± ë° ì‹œê°„ ì†Œìš” ì¶œë ¥
rearranged_data <- lapply(names(target_atlas), function(roi) {
# ROI ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
roi_start_time <- Sys.time()
# ROI ë°ì´í„°ì™€ ê±°ë¦¬ ì •ë³´ ì¶”ì¶œ
roi_dist <- target_atlas[[roi]]
roi_data <- target_data[, names(roi_dist)] %>% t()
# ROI ë°ì´í„°ì˜ í–‰ ì´ë¦„ê³¼ ROI ê±°ë¦¬ì˜ ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
if (all(rownames(roi_data) == names(roi_dist))) {
rownames(roi_data) <- NULL
colnames(roi_data) <- RID
roi_data_2 <- cbind(ROI = names(roi_dist), Euclid_Dist = roi_dist, roi_data) %>%
as_tibble()
} else {
stop(paste("Error: Mismatch in rownames for ROI:", roi))
}
# ROI ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
roi_end_time <- Sys.time()
roi_elapsed_time <- round(difftime(roi_end_time, roi_start_time, units = "secs"), 2)
# ê° ROIì— ëŒ€í•´ ì†Œìš”ëœ ì‹œê°„ ì¶œë ¥
cat(cyan(paste0("Processed ROI: ", roi, " (Time: ", roi_elapsed_time, " seconds)\n")))
return(roi_data_2)
}) %>% setNames(names(target_atlas)) # roi
# ë°ì´í„° ì €ì¥
saveRDS(rearranged_data, save_file_path)
# ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
end_time <- Sys.time()
elapsed_time <- round(difftime(end_time, start_time, units = "secs"), 2)
# ì‹œê°„ ì†Œìš” ì¶œë ¥
cat(green(paste0("Completed: ", target_atlas_name, " (Time: ", elapsed_time, " seconds)\n")))
}
} else {
cat(red("Error: Some atlas names are not in the target file names.\n"))
}
}
# ğŸŸ¥ Load the sorted dist data ==========================================================================================
path_sorted_dist = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/FunCurv/2.Construction of curves by distance/2.Arrange the distances for each ROI by the size/Sorted ROI by dist.rds"
path_sorted_dist = path_sorted_dist %>% adjust_path()
sorted_dist = readRDS(path_sorted_dist)
# ğŸŸ¥ Load the sorted dist data ==========================================================================================
path_sorted_dist = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/FunCurv/2.Construction of curves by distance/2.Arrange the distances for each ROI by the size/Sorted ROI by dist.rds"
path_sorted_dist = path_sorted_dist %>% adjust_path()
sorted_dist = readRDS(path_sorted_dist)
# ğŸŸ¥ Sort each dataset ===========================================================================================
## ğŸŸ© FC ===============================================
### ğŸŸ¨ FunImgARCWSF ===============================================================
# FC files list
path_folder = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/ADNI_SB/âœ´ï¸â­ï¸3.ROI-defined results/âœ…âœ´ï¸â­ï¸2.Functional Connectivity/FunImgARCWSF/Fisher Z Transformation"
path_folder = path_folder %>% adjust_path
# save path
path_save = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/FunCurv/2.Construction of curves by distance/3.Curves by Distance/FunImgARCWSF/Fisher Z FC"
path_save = path_save %>% adjust_path
### ğŸŸ¨ FunImgARglobalCWSF ===============================================================
# FC files list
path_folder = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/ADNI_SB/âœ´ï¸â­ï¸3.ROI-defined results/âœ…âœ´ï¸â­ï¸2.Functional Connectivity/global/Fisher Z Transformation"
path_folder = path_folder %>% adjust_path
# save path
path_save = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/FunCurv/2.Construction of curves by distance/3.Curves by Distance/FunImgARglobalCWSF/Fisher Z FC"
path_save = path_save %>% adjust_path
# process and save
process_and_save_fc_data(path_folder, path_save, sorted_dist)
# ğŸŸ¥ Load Functions & Packages ##########################################################################
# rm(list = ls())
Sys.setlocale("LC_ALL", "en_US.UTF-8")
## ğŸŸ¨Install and loading Packages ================================
install_packages = function(packages, load=TRUE) {
# load : load the packages after installation?
for(pkg in packages) {
if (!require(pkg, character.only = TRUE)) {
install.packages(pkg)
}
if(load){
library(pkg, character.only = TRUE, quietly = T)
}
}
}
List.list = list()
List.list[[1]] = visual = c("ggpubr", "ggplot2", "ggstatsplot", "ggsignif", "rlang", "RColorBrewer", "reshape2")
List.list[[2]] = stat = c("fda", "MASS")
List.list[[3]] = data_handling = c("tidyverse", "dplyr", "clipr", "tidyr", "readr", "caret", "readxl")
List.list[[4]] = qmd = c("janitor", "knitr")
List.list[[5]] = texts = c("stringr", "stringi")
List.list[[6]] = misc = c("devtools")
List.list[[7]] = db = c("RMySQL", "DBI", "odbc", "RSQL", "RSQLite")
List.list[[8]] = sampling = c("rsample")
List.list[[9]] = excel = c("openxlsx")
List.list[[10]] = others = c("beepr")
packages_to_install_and_load = unlist(List.list)
install_packages(packages_to_install_and_load)
## ğŸŸ§dplyr =======================================================
filter = dplyr::filter
select = dplyr::select
# ğŸŸ¥ Define Functions ##########################################################################
##  ğŸŸ© path ===============================================================================
# ê²½ë¡œ ìë™ ë³€í™˜ í•¨ìˆ˜ ì •ì˜
adjust_path <- function(path) {
# ìš´ì˜ì²´ì œì— ë”°ë¼ ê¸°ë³¸ ê²½ë¡œ ì•ë¶€ë¶„ ì„¤ì •
if (.Platform$OS.type == "windows") {
# macOS ê²½ë¡œë¥¼ Windows ê²½ë¡œë¡œ ë³€í™˜
path <- sub("^/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/", "E:/", path)
} else if (.Platform$OS.type == "unix" && grepl("darwin", R.version$os)) {
# ì´ë¯¸ macOS ê²½ë¡œì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
path <- path
} else {
stop("ì§€ì›ë˜ì§€ ì•ŠëŠ” ìš´ì˜ì²´ì œì…ë‹ˆë‹¤.")
}
# ìµœì¢… ê²½ë¡œ ë°˜í™˜
return(path)
}
##  ğŸŸ© plot ===============================================================================
ggplot___lines = function(df,
col_names = NULL,
x_col = "Year",
x_axis_vals = NULL,
# options
point = T,
show.legend = T,
# labels
title = "Timeseries",
xlab = "Year",
ylab = "Value",
color_legend_title = "Category",
# export
path_Export = NULL,
file.name = NULL,
width = 20,
height = 5){
# ğŸŸ¥ Colnames ====================================================================
## ğŸŸ¨ Check input ===============================================================
if(is.null(col_names)){
col_names = colnames(df)
col_names = col_names[col_names != x_col]
}
## ğŸŸ¨ Subset ===============================================================
df_selected = df[, c(x_col, col_names), drop = FALSE]
# ğŸŸ¥ x-axis ====================================================================
if(is.null(x_axis_vals)){
x_axis_vals = 1:nrow(df_selected)
}
if(nrow(df_selected)!=length(x_axis_vals)){
stop("Compare the length of x_axis_vals and the rows of df")
}
x_axis_labs = df_selected[, x_col]
# ğŸŸ¥ Transform data into long format ============================================================
df_selected$Year = df_selected$Year %>% as.numeric
long_df = df_selected %>% pivot_longer(cols = -!!x_col,
names_to = "Category",
values_to = "Value") %>% dplyr::arrange(Category, !!x_col)
# ğŸŸ¥ Add x-axis vals ============================================================
x.axis_df = cbind(x_axis_vals = x_axis_vals, long_df)
x.axis_df$Value = as.numeric(x.axis_df$Value)
x.axis_df$x_axis_vals = as.numeric(x.axis_df$x_axis_vals)
# ğŸŸ¥ plotting ====================================================================
## ğŸŸ¨ Line ============================================================================
p <- ggplot() +
geom_line(data = x.axis_df, aes(x = x_axis_vals, y = Value, group = Category, color = Category),
show.legend = show.legend)
## ğŸŸ¨ Point ============================================================================
if(point){
p = p + geom_point(data = x.axis_df,
aes(x = x_axis_vals, y = Value, group = Category, color = Category),
show.legend = FALSE) # ì„  ìœ„ì— ì  ì¶”ê°€, ë²”ë¡€ëŠ” ì´ë¯¸ geom_lineì—ì„œ í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
}
## ğŸŸ¨ Lables ============================================================================
p = p + scale_x_discrete(limits = x_axis_labs) + # xì¶• ë¼ë²¨ ì§€ì •
theme_minimal() +
labs(title = title, x = xlab, y = ylab, color = color_legend_title)
## ğŸŸ¨ Theme ============================================================================
p = p + theme(plot.title = element_text(hjust = 0.5, size = 25, face = "bold"), # íƒ€ì´í‹€ ê°€ìš´ë° ì •ë ¬
axis.title.x = element_text(size = 20, face = "bold"), # x ì¶• ë¼ë²¨ í¬ê¸° ë° êµµê¸° ì¡°ì •
axis.title.y = element_text(size = 20, face = "bold"), # y ì¶• ë¼ë²¨ í¬ê¸° ë° êµµê¸° ì¡°ì •
legend.title = element_text(size = 17, face = "bold") # ë²”ë¡€ ì œëª© í¬ê¸° ë° êµµê¸° ì¡°ì •
)
# ğŸŸ¥ Exporting =================================================================================
if(!is.null(path_Export)){
ggsave(paste0(path_Export, "/", file.name, ".png"), p, bg = "white", width = width, height = height)
}
return(p)
}
## ğŸŸ© FC ==================================================================================================
combine_fisher_z_fc <- function(data_list) {
# Distì™€ ROIê°€ ë™ì¼í•œì§€ í™•ì¸
dist_roi_check <- lapply(data_list, function(df) df[, c("Dist", "ROI")])
# x = dist_roi_check[[2]]
if (!all(sapply(dist_roi_check, function(x) identical(x, dist_roi_check[[1]])))) {
stop("Error: Not all 'Dist' and 'ROI' columns are identical across data frames.")
}
# ë™ì¼í•œ Distì™€ ROIë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²°í•©
dist_and_roi <- dist_roi_check[[1]]  # Distì™€ ROIë¥¼ í¬í•¨í•œ ì²« ë²ˆì§¸ ë°ì´í„°í”„ë ˆì„
# ê° ë°ì´í„°í”„ë ˆì„ì˜ Fisher_Z_FC ì—´ ì´ë¦„ì„ ë¦¬ìŠ¤íŠ¸ ì›ì†Œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ cbind
combined_data <- lapply(names(data_list), function(name) {
# name = names(data_list)[1]
df <- data_list[[name]]
df[["Fisher_Z_FC"]] %>% as_tibble %>% setNames(name)  # ì—´ ì´ë¦„ì„ ë¦¬ìŠ¤íŠ¸ ì›ì†Œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
}) %>% do.call(cbind, .) %>% cbind(dist_and_roi, .) %>% as_tibble
return(combined_data)
}
# FC ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ì €ì¥í•˜ëŠ” í•¨ìˆ˜ ì •ì˜
process_and_save_fc_data <- function(path_folder, path_save, sorted_dist) {
require(tools)  # 'tools' íŒ¨í‚¤ì§€ ë¡œë“œ
fc_data_list <- list.files(path_folder, full.names = TRUE)  # FC ë°ì´í„° íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
for (ith_fc_path in fc_data_list) {
# ì•„í‹€ë¼ìŠ¤ ì´ë¦„ ì¶”ì¶œ ë° ì €ì¥ ê²½ë¡œ ìƒì„±
ith_atlas <- basename(ith_fc_path) %>%
file_path_sans_ext() %>%
sub("_combined_Fisher_Z_fc$", "", .)
save_file_path <- file.path(path_save, paste0(ith_atlas, ".rds"))
# íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆë›°ê¸°
if (file.exists(save_file_path)) {
cat(crayon::red(paste("File already exists for atlas:", ith_atlas, ". Skipping processing.\n")))
next  # ë‹¤ìŒ íŒŒì¼ë¡œ ë„˜ì–´ê°€ê¸°
}
total_start_time <- Sys.time()  # ì „ì²´ ì²˜ë¦¬ ì‹œê°„ ì‹œì‘
# íŒŒì¼ ì½ê¸°, ì—ëŸ¬ ì²˜ë¦¬
tryCatch({
ith_fc <- readRDS(ith_fc_path)
}, error = function(e) {
cat(crayon::red(paste("Error reading file:", ith_fc_path, "\n")))
next  # íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í•˜ë©´ ê±´ë„ˆë›°ê¸°
})
# ê±°ë¦¬ ì •ë³´ ì •ë ¬
ith_sorted_dist <- sorted_dist[[ith_atlas]]
ith_sorted_FC_data <- list()
# ì •ë ¬ ìˆ˜í–‰ ë° ì‹œê°„ ì¸¡ì •
tictoc::tic("Sorting")
each_rid_sorted_FC_list <- lapply(names(ith_fc), function(rid) {
rid_fc <- ith_fc[[rid]]
rid_sorted_FC_list <- lapply(names(ith_sorted_dist), function(roi) {
roi_rid_fc <- rid_fc[, roi]
roi_dist <- ith_sorted_dist[[roi]]
selected_roi_rid_fc <- roi_rid_fc[names(roi_rid_fc) %in% names(roi_dist)]
sorted_selected_roi_rid_fc <- selected_roi_rid_fc[names(roi_dist)]
data.frame(
Dist = roi_dist,
ROI = names(sorted_selected_roi_rid_fc),
Fisher_Z_FC = sorted_selected_roi_rid_fc
) %>% as_tibble()
}) %>% setNames(names(ith_sorted_dist))
return(rid_sorted_FC_list)
}) %>% setNames(names(ith_fc))
tictoc::toc()  # ì •ë ¬ ì¢…ë£Œ
# ROI ë³„ë¡œ ë°ì´í„° ì²˜ë¦¬ ë° ì‹œê°„ ì¸¡ì •
final_combined_data_list <- lapply(names(ith_sorted_dist), function(roi) {
start_time <- Sys.time()  # ROI ì²˜ë¦¬ ì‹œì‘ ì‹œê°„
combined_roi_fc <- lapply(names(each_rid_sorted_FC_list), function(rid) {
each_rid_sorted_FC_list[[rid]][[roi]]
}) %>%
setNames(names(each_rid_sorted_FC_list)) %>%
combine_fisher_z_fc  # Fisher_Z_FC ê²°í•©
end_time <- Sys.time()  # ROI ì²˜ë¦¬ ì¢…ë£Œ ì‹œê°„
elapsed_time <- end_time - start_time  # ì†Œìš” ì‹œê°„ ê³„ì‚°
# ì²˜ë¦¬ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
cat(crayon::blue(paste0("Finished processing atlas: ", ith_atlas,
" | ROI: ", roi, "\n")))
cat(crayon::green(paste0("Time taken for ROI ", roi, ": ",
round(elapsed_time, 2), " seconds\n")))
return(combined_roi_fc)  # ROI ë°ì´í„° ë°˜í™˜
}) %>% setNames(names(ith_sorted_dist))
# ìµœì¢… ê²°ê³¼ ì €ì¥
saveRDS(final_combined_data_list, save_file_path)
# ì „ì²´ ì²˜ë¦¬ ì‹œê°„ ê³„ì‚° ë° ì¶œë ¥
total_end_time <- Sys.time()
total_elapsed_time <- total_end_time - total_start_time
cat(crayon::yellow(paste0("Finished processing atlas: ", ith_atlas,
" | Total time taken: ",
round(total_elapsed_time, 2), " seconds\n")))
}
}
## ğŸŸ© ReHo, DC, ALFF ==================================================================================================
process_roi_data <- function(path_data_folder, sorted_dist, path_save) {
# ì €ì¥í•  ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
if (!dir.exists(path_save)) {
dir.create(path_save, recursive = TRUE)
}
# `Mean__`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  rds íŒŒì¼ì˜ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
path_target_data <- list.files(path_data_folder, pattern = "^Mean__.*\\.rds$", full.names = TRUE)
# atlas ì´ë¦„ ì¶”ì¶œ
target_file_names <- list.files(path_data_folder, pattern = "\\.rds$", full.names = FALSE) %>%
sub("\\.rds$", "", .)
target_file_names = target_file_names[!grepl("^Mean__", target_file_names)]
# ì •ë ¬ëœ dist ëª©ë¡ì˜ ì´ë¦„ì´ íŒŒì¼ ì´ë¦„ì— ëª¨ë‘ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
if (all(names(sorted_dist) %in% target_file_names)) {
for (target_atlas_name in target_file_names) {
# target_atlas_name = target_file_names[2]
# ì´ë¯¸ ì €ì¥ëœ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
save_file_path <- file.path(path_save, paste0(target_atlas_name, ".rds"))
if (file.exists(save_file_path)) {
cat(yellow(paste0("Skipping: ", target_atlas_name, " (File already exists)\n")))
next
}
# ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
start_time <- Sys.time()
# í•´ë‹¹ atlasì— ëŒ€í•œ dist ë°ì´í„°ì™€ target data ë¡œë“œ
target_atlas <- sorted_dist[[target_atlas_name]]
target_data <- readRDS(path_target_data[which(target_file_names == target_atlas_name)])
# target_data %>% View
# RID ì¶”ì¶œ ë° target_dataì˜ RID ì—´ ì œê±°
RID <- regmatches(target_data$RID, regexpr("RID_\\d+", target_data$RID))
target_data$RID <- NULL
# ê° ROIì— ëŒ€í•´ ë°ì´í„° ì¬êµ¬ì„± ë° ì‹œê°„ ì†Œìš” ì¶œë ¥
rearranged_data <- lapply(names(target_atlas), function(roi) {
# ROI ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
roi_start_time <- Sys.time()
# ROI ë°ì´í„°ì™€ ê±°ë¦¬ ì •ë³´ ì¶”ì¶œ
roi_dist <- target_atlas[[roi]]
roi_data <- target_data[, names(roi_dist)] %>% t()
# ROI ë°ì´í„°ì˜ í–‰ ì´ë¦„ê³¼ ROI ê±°ë¦¬ì˜ ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
if (all(rownames(roi_data) == names(roi_dist))) {
rownames(roi_data) <- NULL
colnames(roi_data) <- RID
roi_data_2 <- cbind(ROI = names(roi_dist), Euclid_Dist = roi_dist, roi_data) %>%
as_tibble()
} else {
stop(paste("Error: Mismatch in rownames for ROI:", roi))
}
# ROI ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
roi_end_time <- Sys.time()
roi_elapsed_time <- round(difftime(roi_end_time, roi_start_time, units = "secs"), 2)
# ê° ROIì— ëŒ€í•´ ì†Œìš”ëœ ì‹œê°„ ì¶œë ¥
cat(cyan(paste0("Processed ROI: ", roi, " (Time: ", roi_elapsed_time, " seconds)\n")))
return(roi_data_2)
}) %>% setNames(names(target_atlas)) # roi
# ë°ì´í„° ì €ì¥
saveRDS(rearranged_data, save_file_path)
# ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
end_time <- Sys.time()
elapsed_time <- round(difftime(end_time, start_time, units = "secs"), 2)
# ì‹œê°„ ì†Œìš” ì¶œë ¥
cat(green(paste0("Completed: ", target_atlas_name, " (Time: ", elapsed_time, " seconds)\n")))
}
} else {
cat(red("Error: Some atlas names are not in the target file names.\n"))
}
}
path_folder = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/ADNI_SB/âœ´ï¸â­ï¸3.ROI-defined results/âœ…âœ´ï¸â­ï¸2.Functional Connectivity/FunImgARCWSF/Fisher Z Transformation"
path_folder = path_folder %>% adjust_path
# save path
path_save = "/Volumes/ADNI_SB_SSD_NTFS_4TB_Sandisk/FunCurv/2.Construction of curves by distance/3.Curves by Distance/FunImgARCWSF/Fisher Z FC"
path_save = path_save %>% adjust_path
# process and save
process_and_save_fc_data(path_folder, path_save, sorted_dist)
